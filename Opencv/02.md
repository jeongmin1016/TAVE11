# chap4 에지와 영역

#### 에지 
물체 경계에 위치한 점 
- 에지 검출 : 에지에 해당 화소 찾기
- 에지 향상 : 에지 더 잘보이도록 하기 위해 에지와 배경 간의 대비 증가
- 에지 추적 : 에지 따라가기

- 에지를 완벽하게 검출해 물체의 경계를 폐곡선으로 따낼 수 있다면 분할 문제 해결
- 특성이 크게 다른 화소에 집중하는 방식

-> 물체의 위치 모양 크기 에 대한 정보 찾기 가능

#### 영역
특성이 비슷한 화소를 묶는 방식


에지 검출 알고리즘 : 물체 내부는 명암이 서서히 변하고 경계는 급격히 변하는 특성 활용

### 4.1.1 영상의 미분
미분 : 변수의 x 값이 미세하게 증가했을 때 함수 변화량 측정, 에지 추출 방법

* 영상을 (x, y) 변수의 함수로 간주했을 때, 이 함수의 1차 미분(1st derivative) 값이 크게 나타나는 부분을 검출

디지털 영상 미분
- 미분은 기본적으로 연속적인 공간에서 적용, but 영상은 연속공간이 아닌 이산 공간이기에 근사화한 것으로 적용
- 영상 f에 미분 적용해 f' -> 영상에서 가장 작은 단위가 1이며 (-1,1)로 컨볼루션
- 필터 u(에지 연산자)로 컨볼루션하여 구현
- 명암을 미분해 튀어나온 부분이 에지

### 4.1.2 에지 연산자
- 명암 변화 x = 0
- 명암 변화 o = 3 
- 에지 검출은 모두 명암 변화에만 의존, 두 인접한 물체가 비슷한 명암을 가져 명암 변화가 적은 경우 경계에서 에지 발생X

컨볼루션의 값은 f 원래 영상의 부호를 의미한다 !?

물체 경계를 지나면서 명암값이 커지면 미분값 양수, 작아지면 음수


램프에지 : 계단 모양이 아닌, 명암이 몇화소에 걸쳐 변화, 정확한 에지의 위치 찾기 어려움

---- 에지 검출 과정 --- 
두꺼운 에지에서 위치 찾기 적용

1차미분 : 원래 영상의 변화량이 1차 미분값 
에지 발생여부와 에지가 어떤 방향을 향하는지 알 수 있음
봉우리 찾기

2차미분 : 1차 미분값의 변화량이 2차 미분값
영교차 찾기 

![image](https://user-images.githubusercontent.com/109460178/227122703-6325016c-3126-446e-86b0-d14d2499b2ee.png)
-	봉우리 : 봉우리의  두께가 1이므로 계단 에지만 존재하는 경우 에지 찾기 간단
-	영교차 : 왼쪽과 오른쪽에 부호가 다른 반응 발생, 자신은 0을 갖는 위치

#### 1차 미분에 기반한 에지 연산자
미분에 기반한 2차원 에지 연산자는 크기 확장시 잡음을 흠수해 더 좋은 성능 보임
-> 잡음으로 인해 스무딩이 필요해 2차원 연산저 적용

- 프로윗 
   장점 : 돌출된 값을 잘 평균화
   단점 : 값이 일렬로 나열되어 있어 대각선보다 수평 수직에 놓인 에지에 민감

- 소벨 
    장점: 돌출된 값 잘 평균화, 모든 방향 에지 검출 가능, 잡음에 강함
    단점 : 대각선 방향에 놓인 에지 민감
    
실제영상에서 구한 그래디언트 크기와 방향은 프레윗과 소벨을 적용한 결과 영상
- 에지 강도 : 크기 = 픽셀 값의 차이 정도, 변화량 -> 에지 가능성 나타냄
- 에지 방향 : 방향 = 값이 급격히 증가하는 방향 -> 에지 진행 방향 나타냄

![image](https://user-images.githubusercontent.com/109460178/227124583-f145bb2f-f6e8-4783-9ab3-9f3d2f055de9.png)

각각 프로윗 소벨 적용한 값을 기반으로 에지 방향 구함


## 4.2 캐니 에지
1. 블러링 통한 노이즈 제거 : 5*5 크기의 가우시안 필터 적용해 불필요 잠음 제거
2. 그래디언트 계산 : 기울기의 크기와 방향 계산
**3. 비최대치 억제**   
현재 화소가 이웃하는 화소들보다 크면 보존, 그렇지 않으면 에지가 아닌 것으로 간주 == 최대가 아니면 억제   
에지 방향에 수직인 두 이웃 화소의 에지 강도 비교

**4. 이력 임계값으로 에지 결정**   
실제 에지가 아닌데 에지로 검출된 화소인 거짓 긍정을 줄이기 위해 임계값 사용   
두개의 임계값 T(high), T(low)를 사용해서 에지의 이력을 추적하여 에지를 결정하는 방법  
![image](https://user-images.githubusercontent.com/109460178/227133915-5b6112c4-c68b-4029-bb13-bbbd3dd99b45.png)

- 에지 추적은 T_high를 넘는 화소에서 시작, 추적 도중에는 T_low 적용 
- 이웃 화소가 추적이력이 있으면 자신은 신뢰도가 낮더라도 에지로 간주
- 추적 시작하지 않은 이웃 화소들을 대상으로  T(low)보디 큰 화소 에지 결정



## 4.3 직선 검출
에지 화소는 1, 에지가 아닌 화소 0  
**에지를 연결해 경계선으로 변환하고 경계선을 직선으로 변환 -> 물체 표현이나 인식에 유리**  

1) 에지 맵에서 경계선 검출 2) 길이가 임계값 이상인 경계선만 취함

##### findCountours 사용
- 경계선 찾을 에지 영상
- 구멍이 있는 경우 바깥쪽 경계선과 그 안에 구멍의 경계선을 계층적으로 찾는 방식 지정
  -> cv.RETR_LIST : 맨 바깥쪽 경계선 찾기
- 경계선 표현 방식 지정
   -> cv.CHAIN_APPROX_NONE : 모든 점 기록 / cv.CHAIN_APPROX_SIMPLE : 직선에 대해 양 끝점만 기록 / cv.CHAIN_APPROX_TC89_L1 & cv.CHAIN_APPROX_TC89_KCOS : Teh-Chin 알고리즘으로 굴곡이 심한 점 찾아 기록
   
   • contours: 검출된 외곽선 좌표
   • hierarchy: 외곽선 계층 정보     
   
##### drawCountours 사용
왔다갔다 반복되는 부분이 있어서, 50이상의 경계선을 검출하고 싶다면 한계 100
-> 함수는 시작점부터 끝점까지 추적한 다음 역추적하여 시작점으로 돌아와 경계선 표현하기 때문
- 경계선 그려넣을 영상
- 경계선
- 모든 경계선 그리기 (-1), 해당 번호에 해당하는 경계선 하나만 그리기 (양수)
- 색
- 두께




#### 허프변환
잡음 발생 : 에지가 자잘하게 끊겨 나타나는 경우 발생 -> **"허프변환"** 적용하면 끊긴 에지 모아 선분 or 원 등 검출
- 직선의 방정식 이용
1) 공간 (x,y)에 위치한 직선 y = ax + b
2) b = -ax + y 로 변경 가능하며 이는 a, b를 변수로 취급, 새로운 공간 (a,b) 생성
3) 1)에서 점이였던 것이 공간이 변하며 직선으로 변경
4) 새로운 공간에서의 두개의 직선이 만난다면 이 만나는 점은 원래 공간에서 두 점을 지나는 직선의 기울기와 y절편

![image](https://user-images.githubusercontent.com/109460178/227456183-f429d1da-7a58-40ba-acb5-d4d970bd96f5.png)

   -> (a,b) 공간에서 **두 직선이 만나는 점은 투표**로 알아냄
   -> 직선이 지나지 않음 0, 직선이 지남 1, 두 직선이 만남 2
   
발생 시 고려사항 
조건1) fact, 많은 점들이 있고 점들이 완전히 일직선을 이루진 않음
   -> (a,b)공간을 이산화해 해결 : 2차원 누적 배열 v 생성, v를 0으로 초기화한 다음 각각 직선은 자신이 지나는 모든 칸에 1만큼 투표
   
조건2) 투표가 이뤄진 누적 배열에 잡음 많음
   -> 비최대억제로 잡음이 많은 상태에서 한 점 결정
   
![image](https://user-images.githubusercontent.com/109460178/227457314-9d0d99c8-2bd1-4697-9101-273d619b2b93.png)
:: 비최대억제로 극점 3개 남았는데 임계값을 적용해 노란색점 2개가 최종

조건3) y = ax + b, 기울기 a가 무한대인 경우 투표 불가
   -> 극좌표에서 직선의 방정식 표현하는 식으로 해결 ![image](https://user-images.githubusercontent.com/109460178/227457688-c7c771ff-f27f-4def-bd21-29f09699231f.png)

+ 한계점)
   직선의 양끝점 알려주지 못함      
   -> 비최대억제과정에서 극점을 형성한 화소를 찾아 가장 먼 곳에 있는 두 화소 계산하는 추가 과정 필요
   ex) 원 검출하기 위해 원의 방정식 이용
   
   
![image](https://user-images.githubusercontent.com/109460178/227459955-84904244-460b-4820-84f0-dee20f1c53ea.png)

- 명암영상에서 원 검출해 중심과 반지름 저장한 리스트 반환
- 여러 변형 알고리즘 중 하나 지정 
   -> cv.HOUGH_GRADIENT : 에지 방향 정보 추가 사용
- 누적 배열의 크기 지정 
   -> 1 : 입력 영상과 동일 크기 사용
- 원 사이의 최소 거리 지정, 작을수록 많은 원 검출
- 캐니 에지 알고리즘이 사용하는 임계값 T_high
- 비최대 억제 적용할 때 사용하는 임계값
- 원의 최소 반지름 
- 원의 최대 반지름


허프변환 문제점 : 이상치가 섞여있을 수 있는데 허프변환은 모든 점에 동일한 투표기회를 제공하기 때문에 누적 배열에 잡음이 많이 발생하는 원인


##### 최소평균제곱오차 알고리즘
허프변환과 유사함 (이상치에 민감함)
모든 점을 대상으로 오류 계산하고 최소 오류 범하는 직선 찾기   

![image](https://user-images.githubusercontent.com/109460178/227461993-a22cd671-d128-44ee-94ce-a2e29a92c879.png)

아웃라이어의 영향으로 실제에서 벗어난 직선 찾음, 모든 샘플이 동등한 자격으로 오류 계산 참여


문제점 해결을 위해 아래 알고리즘 적용   

##### 강인한 추정 
아웃 라이어를 걸러내는 과정을 가진 추정 기법
=> 중앙값을 이용해 아웃라이어를 배제하여 추정하기 때문

##### RANSAC
인라이어와 아웃라이어가 섞여 있는 상황에서 인라이어를 찾아 최적 근사하는 기법
1) 랜덤하게 두 점 서택, 두점을 지나는 직선 계산 
2) 일정한 양의 오차 t를 허용해 직선에 일치하는 점의 개수 count
3) 개수가 임곗값 d를 넘지 못하면 가능성 X -> 버림
4) 3번 통과시, 해당 점의 개수로 최적 직선 추정하고 추정 오류가 임계값 e보다 작으면 후보군 추가 아니면 out
5) 3번과 4번의 반복으로 후보군에서 최적 찾기


![image](https://user-images.githubusercontent.com/109460178/227463259-04303c7b-e2f2-4253-ac4d-81fd25a37a28.png)
a. d=5라면 해당점이 3개이기에 out
b. d=5라면 해당점이 7이기에 ok, 그러나 7개로 최적 직선 추정하고 추정 오류가 임계값 e보다 작으면 후보군 추가 아니면 out


장점 : 반복횟수가 많아 직선 찾을 가능성 up
단점 : 시간이 더 걸려 적절한 값 설정 필요













